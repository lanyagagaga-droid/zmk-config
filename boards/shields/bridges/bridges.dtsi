/*
 * Copyright (c) 2025 Vincent Franco
 * SPDX-License-Identifier: MIT
 */
#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/zmk/input_transform.h>
#include <input/processors.dtsi>

#include "fifty_four_layout.dtsi"
#include "forty_two_layout.dtsi"
#include "thirty_six_layout.dtsi"

#define DEF 0
#define MOUSE 1
#define SYM 2
#define NUM 3
#define FN 4
#define GENSHIN 5 

&gggw_bridges_54_layout {
  transform = <&default_transform>;
};

&gggw_bridges_42_layout {
  transform = <&forty_two_transform>;
};

&gggw_bridges_36_layout {
  transform = <&thirty_six_transform>;
};

/ {
  chosen {
    zmk,kscan = &kscan0;
    zmk,physical-layout = &gggw_bridges_54_layout;
  };

  default_transform: keymap_transform0 {
    compatible = "zmk,matrix-transform";
    columns = <12>;
    rows = <5>;
    map = <RC(0,0) RC(0,1) RC(0,2) RC(0,3) RC(0,4) RC(0,5) RC(0,6) RC(0,7) RC(0,8) RC(0,9) RC(0,10)
           RC(0,11) RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,5) RC(1,6) RC(1,7) RC(1,8) RC(1,9)
           RC(1,10) RC(1,11) RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,5) RC(2,6) RC(2,7) RC(2,8)
           RC(2,9) RC(2,10) RC(2,11) RC(3,0) RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,5) RC(3,6) RC(3,7)
           RC(3,8) RC(3,9) RC(3,10) RC(3,11) RC(4,3) RC(4,4) RC(4,5) RC(4,6) RC(4,7) RC(4,8)>;
  };

  forty_two_transform: keymap_transform1 {
    compatible = "zmk,matrix-transform";
    columns = <12>;
    rows = <5>;
    map = <RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,5) RC(1,6) RC(1,7) RC(1,8) RC(1,9) RC(1,10)
           RC(1,11) RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,5) RC(2,6) RC(2,7) RC(2,8) RC(2,9)
           RC(2,10) RC(2,11) RC(3,0) RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,5) RC(3,6) RC(3,7) RC(3,8)
           RC(3,9) RC(3,10) RC(3,11) RC(4,3) RC(4,4) RC(4,5) RC(4,6) RC(4,7) RC(4,8)>;
  };

  thirty_six_transform: keymap_transform2 {
    compatible = "zmk,matrix-transform";
    columns = <12>;
    rows = <5>;
    map = <RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,5) RC(1,6) RC(1,7) RC(1,8) RC(1,9) RC(1,10)
           RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,5) RC(2,6) RC(2,7) RC(2,8) RC(2,9) RC(2,10)
           RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,5) RC(3,6) RC(3,7) RC(3,8) RC(3,9) RC(3,10)
           RC(4,3) RC(4,4) RC(4,5) RC(4,6) RC(4,7) RC(4,8)>;
  };

  kscan0: kscan0 {
    diode-direction = "col2row";
  };

  //left hand trackball
  split_inputs {
    #address-cells = <1>;
    #size-cells = <0>;

    trackball_left_split: trackball_split@0 {
      compatible = "zmk,input-split";
      reg = <0>;
    };

    trackball_right_split: trackball_split@1 {
      compatible = "zmk,input-split";
      reg = <1>;
    };
  };

  trackball_left_listener: trackball_left_listener {
    compatible = "zmk,input-listener";
    status = "disabled";
    device = <&trackball_left_split>;

    snipe {
      layers = <NUM>;
      input-processors = <&zip_xy_scaler 1 3>;
    };

    scroll {
      layers = <SYM>;
      input-processors = <&zip_xy_transform INPUT_TRANSFORM_Y_INVERT>, <&zip_xy_scaler 1 3>,
                         <&zip_xy_to_scroll_mapper>;
    };

    move {
      layers = <DEF MOUSE>;
      input-processors = <&auto_mouse_layer MOUSE 5000>;
    };
  };

  trackball_right_listener: trackball_right_listener {
    compatible = "zmk,input-listener";
    status = "disabled";
    device = <&trackball_right_split>;

    snipe {
      layers = <NUM>;
      input-processors = <&zip_xy_scaler 1 3>;
    };

    scroll {
      layers = <SYM>;
      input-processors = <&zip_xy_transform INPUT_TRANSFORM_Y_INVERT>, <&zip_xy_scaler 1 3>,
                         <&zip_xy_to_scroll_mapper>;
    };

    move {
      layers = <DEF MOUSE>;
      input-processors = <&auto_mouse_layer MOUSE 5000>;
    };
  };

  auto_mouse_layer: auto_mouse_layer {
    compatible = "zmk,input-processor-temp-layer";
    #input-processor-cells = <2>;
    require-prior-idle-ms = <500>;
    excluded-positions = <30 31 32 16 17 18 10 11 12 13 22 23>;
  };
};
